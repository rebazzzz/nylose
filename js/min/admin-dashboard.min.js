function showSection(t){document.querySelectorAll(".content-section").forEach(t=>t.style.display="none");var e=document.getElementById(t+"-section");if(e)switch(e.style.display="block",t){case"members":loadMembers();break;case"sports":loadSports();break;case"schedules":loadSchedules();break;case"statistics":loadStatistics()}}function hideAllSections(){document.querySelectorAll(".content-section").forEach(t=>t.style.display="none")}function showAddSportModal(){document.getElementById("add-sport-modal").style.display="block"}function showAddScheduleModal(){document.getElementById("add-schedule-modal").style.display="block"}function showAddAdminModal(){document.getElementById("add-admin-modal").style.display="block"}function closeModal(t){document.getElementById(t).style.display="none"}async function loadDashboardCounts(){try{var[t,e,a]=await Promise.all([fetch("http://localhost:3001/api/admin/members?t="+Date.now(),{headers:{Authorization:"Bearer "+localStorage.getItem("token")}}),fetch("http://localhost:3001/api/admin/sports?t="+Date.now(),{headers:{Authorization:"Bearer "+localStorage.getItem("token")}}),fetch("http://localhost:3001/api/admin/schedules?t="+Date.now(),{headers:{Authorization:"Bearer "+localStorage.getItem("token")}})]),o=await t.json(),n=await e.json(),d=await a.json();document.getElementById("members-count").textContent=o.length+" medlemmar",document.getElementById("sports-count").textContent=n.length+" sporter",document.getElementById("schedules-count").textContent=d.length+" scheman"}catch(t){console.error("Error loading dashboard counts:",t),document.getElementById("members-count").textContent="Kunde inte ladda",document.getElementById("sports-count").textContent="Kunde inte ladda",document.getElementById("schedules-count").textContent="Kunde inte ladda"}}function hideAllSections(){document.querySelectorAll(".content-section").forEach(t=>t.style.display="none")}async function loadMembers(){try{var t=await fetch("http://localhost:3001/api/admin/members?t="+Date.now(),{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch members");var e=await t.json(),a=document.getElementById("members-tbody");0===e.length?a.innerHTML='<tr><td colspan="9">Inga medlemmar registrerade</td></tr>':a.innerHTML=e.map(t=>{let e="-";return t.parent_name&&(e=""+t.parent_name,t.parent_lastname&&(e+=" "+t.parent_lastname),t.parent_phone)&&(e+=` (${t.parent_phone})`),`
            <tr>
                <td>${t.id}</td>
                <td>${t.first_name} ${t.last_name}</td>
                <td>${t.personnummer||"-"}</td>
                <td>${t.email}</td>
                <td>${t.phone||"-"}</td>
                <td>${t.address||"-"}</td>
                <td>${e}</td>
                <td>
                    <span class="status ${t.is_active?"active":"inactive"}">
                        ${t.is_active?"Aktiv":"Inaktiv"}
                    </span>
                </td>
                <td>${new Date(t.created_at).toLocaleDateString("sv-SE")}</td>
            </tr>
        `}).join("")}catch(t){console.error("Error loading members:",t),document.getElementById("members-tbody").innerHTML='<tr><td colspan="9">Kunde inte ladda medlemmar</td></tr>'}}async function loadAdmins(){try{var t=await fetch("http://localhost:3001/api/admin/admins",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch admins");var e=await t.json(),a=document.getElementById("admins-tbody");0===e.length?a.innerHTML='<tr><td colspan="7">Inga administratörer registrerade</td></tr>':a.innerHTML=e.map(t=>`
            <tr>
                <td>${t.id}</td>
                <td>${t.first_name} ${t.last_name}</td>
                <td>${t.email}</td>
                <td>${t.phone||"-"}</td>
                <td>
                    <span class="status ${t.is_active?"active":"inactive"}">
                        ${t.is_active?"Aktiv":"Inaktiv"}
                    </span>
                </td>
                <td>${new Date(t.created_at).toLocaleDateString("sv-SE")}</td>
                <td>
                    <button class="btn btn-small" onclick="toggleAdminStatus(${t.id}, ${!t.is_active})">
                        ${t.is_active?"Inaktivera":"Aktivera"}
                    </button>
                </td>
            </tr>
        `).join("")}catch(t){console.error("Error loading admins:",t),document.getElementById("admins-tbody").innerHTML='<tr><td colspan="7">Kunde inte ladda administratörer</td></tr>'}}async function loadSports(){try{var t=await fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch sports");var e=await t.json(),a=document.getElementById("sports-tbody");0===e.length?a.innerHTML='<tr><td colspan="4">Inga sporter tillgängliga</td></tr>':a.innerHTML=e.map(t=>`
            <tr>
                <td>${t.id}</td>
                <td>${t.name}</td>
                <td>${t.description}</td>
                <td>
                    <button class="btn btn-small" onclick="editSport(${t.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteSport(${t.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join("")}catch(t){console.error("Error loading sports:",t),document.getElementById("sports-tbody").innerHTML='<tr><td colspan="4">Kunde inte ladda sporter</td></tr>'}}async function loadSchedules(){try{var t=await fetch("http://localhost:3001/api/admin/schedules",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch schedules");var e=await t.json(),a=document.getElementById("schedules-tbody");0===e.length?a.innerHTML='<tr><td colspan="6">Inga scheman tillgängliga</td></tr>':a.innerHTML=e.map(t=>`
            <tr>
                <td>${t.id}</td>
                <td>${t.sport_name}</td>
                <td>${t.day_of_week||t.day}</td>
                <td>${t.start_time} - ${t.end_time}</td>
                <td>${t.age_group}</td>
                <td>
                    <button class="btn btn-small" onclick="editSchedule(${t.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteSchedule(${t.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join("")}catch(t){console.error("Error loading schedules:",t),document.getElementById("schedules-tbody").innerHTML='<tr><td colspan="7">Kunde inte ladda schema</td></tr>'}}async function loadStatistics(){try{var t=await fetch("http://localhost:3001/api/admin/statistics",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch statistics");var e=await t.json();document.getElementById("statistics-content").innerHTML=`
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Totalt antal medlemmar</h3>
                    <p class="stat-number">${e.totalUsers}</p>
                </div>
                <div class="stat-card">
                    <h3>Aktiva medlemmar</h3>
                    <p class="stat-number">${e.activeUsers}</p>
                </div>
                <div class="stat-card">
                    <h3>Totalt antal sporter</h3>
                    <p class="stat-number">${e.totalSports}</p>
                </div>
                <div class="stat-card">
                    <h3>Totalt antal scheman</h3>
                    <p class="stat-number">${e.totalSchedules}</p>
                </div>
                <div class="stat-card">
                    <h3>Totala betalningar</h3>
                    <p class="stat-number">${e.totalPayments} kr</p>
                </div>
                <div class="stat-card">
                    <h3>Genomsnittlig betalning</h3>
                    <p class="stat-number">${e.averagePayment} kr</p>
                </div>
            </div>
        `}catch(t){console.error("Error loading statistics:",t),document.getElementById("statistics-content").innerHTML="Kunde inte ladda statistik"}}async function loadSportsForSelect(){try{var t=await fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch sports");let e=await t.json();["schedule-sport","edit-schedule-sport"].forEach(t=>{t=document.getElementById(t);t&&(t.innerHTML='<option value="">Välj sport...</option>'+e.map(t=>`<option value="${t.id}">${t.name}</option>`).join(""))})}catch(t){console.error("Error loading sports for select:",t)}}async function toggleAdminStatus(t,e){try{if(!(await fetch(`http://localhost:3001/api/admin/admins/${t}/status`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({is_active:e})})).ok)throw new Error("Failed to update admin status");loadAdmins(),loadDashboardCounts()}catch(t){console.error("Error updating admin status:",t),showError("Kunde inte uppdatera adminstatus")}}async function deleteSport(t){showConfirm("Är du säker på att du vill ta bort denna sport?","Bekräfta borttagning",async()=>{try{if(!(await fetch("http://localhost:3001/api/admin/sports/"+t,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}})).ok)throw new Error("Failed to delete sport");loadSports(),loadDashboardCounts(),loadSportsForSelect(),showSuccess("Sporten har tagits bort")}catch(t){console.error("Error deleting sport:",t),showError("Kunde inte ta bort sport")}})}async function deleteSchedule(t){showConfirm("Är du säker på att du vill ta bort detta schema?","Bekräfta borttagning",async()=>{try{if(!(await fetch("http://localhost:3001/api/admin/schedules/"+t,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}})).ok)throw new Error("Failed to delete schedule");loadSchedules(),loadDashboardCounts(),showSuccess("Schemat har tagits bort")}catch(t){console.error("Error deleting schedule:",t),showError("Kunde inte ta bort schema")}})}function showAddSportModal(){document.getElementById("add-sport-modal").style.display="block"}function showAddScheduleModal(){document.getElementById("add-schedule-modal").style.display="block"}async function editSport(e){try{var t=await fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch sports");var a=(await t.json()).find(t=>t.id===e);if(!a)throw new Error("Sport not found");document.getElementById("edit-sport-id").value=a.id,document.getElementById("edit-sport-name").value=a.name,document.getElementById("edit-sport-description").value=a.description,document.getElementById("edit-existing-image-path").value=a.image_path||"",document.getElementById("edit-sport-modal").style.display="block"}catch(t){console.error("Error loading sport for edit:",t),showError("Kunde inte ladda sport för redigering")}}async function editSchedule(e){try{var t=await fetch("http://localhost:3001/api/admin/schedules",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!t.ok)throw new Error("Failed to fetch schedules");var a=(await t.json()).find(t=>t.id===e);if(!a)throw new Error("Schedule not found");document.getElementById("edit-schedule-id").value=a.id,document.getElementById("edit-schedule-sport").value=a.sport_id,document.getElementById("edit-schedule-day").value=a.day_of_week||a.day,document.getElementById("edit-schedule-start-time").value=a.start_time,document.getElementById("edit-schedule-end-time").value=a.end_time,document.getElementById("edit-schedule-age-group").value=a.age_group,document.getElementById("edit-schedule-modal").style.display="block"}catch(t){console.error("Error loading schedule for edit:",t),showError("Kunde inte ladda schema för redigering")}}function closeModal(t){document.getElementById(t).style.display="none"}function showNotification(t,e="info",a="Meddelande",o=null,n=null){var d=document.getElementById("notification-modal"),r=document.getElementById("notification-title"),s=document.getElementById("notification-message"),i=document.getElementById("notification-icon"),l=document.getElementById("notification-confirm-btn"),c=document.getElementById("notification-cancel-btn");r.textContent=a,s.textContent=t,i.className="notification-icon";let m="fas fa-info-circle";switch(e){case"success":m="fas fa-check-circle",i.classList.add("success");break;case"error":m="fas fa-exclamation-triangle",i.classList.add("error");break;case"warning":m="fas fa-exclamation-circle",i.classList.add("warning");break;default:i.classList.add("info")}i.innerHTML=`<i class="${m}"></i>`,o||n?(c.style.display="inline-block",l.textContent="Ja",c.textContent="Avbryt",r=l.cloneNode(!0),a=c.cloneNode(!0),l.parentNode.replaceChild(r,l),c.parentNode.replaceChild(a,c),r.addEventListener("click",()=>{closeNotificationModal(),o&&o()}),a.addEventListener("click",()=>{closeNotificationModal(),n&&n()})):(c.style.display="none",l.textContent="OK",l.onclick=closeNotificationModal),d.style.display="block"}function closeNotificationModal(){document.getElementById("notification-modal").style.display="none"}function showSuccess(t,e="Lyckades"){showNotification(t,"success",e)}function showError(t,e="Fel"){showNotification(t,"error",e)}function showWarning(t,e="Varning"){showNotification(t,"warning",e)}function showConfirm(t,e="Bekräfta",a,o=null){showNotification(t,"warning",e,a,o)}function initializeForms(){document.getElementById("add-sport-form").addEventListener("submit",async function(t){t.preventDefault();var t=new FormData,e=(t.append("name",document.getElementById("sport-name").value),t.append("description",document.getElementById("sport-description").value),document.getElementById("sport-image").files[0]);e&&t.append("image",e);try{if(!(await fetch("http://localhost:3001/api/admin/sports",{method:"POST",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:t})).ok)throw new Error("Failed to add sport");closeModal("add-sport-modal"),this.reset(),loadSports(),loadDashboardCounts(),loadSportsForSelect(),showSuccess("Sporten har lagts till")}catch(t){console.error("Error adding sport:",t),showError("Kunde inte lägga till sport")}}),document.getElementById("add-schedule-form").addEventListener("submit",async function(t){t.preventDefault();t={sport_id:parseInt(document.getElementById("schedule-sport").value),day_of_week:document.getElementById("schedule-day").value,start_time:document.getElementById("schedule-start-time").value,end_time:document.getElementById("schedule-end-time").value,age_group:document.getElementById("schedule-age-group").value};try{if(!(await fetch("http://localhost:3001/api/admin/schedules",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(t)})).ok)throw new Error("Failed to add schedule");closeModal("add-schedule-modal"),this.reset(),loadSchedules(),loadDashboardCounts(),showSuccess("Schemat har lagts till")}catch(t){console.error("Error adding schedule:",t),showError("Kunde inte lägga till schema")}}),document.getElementById("edit-sport-form").addEventListener("submit",async function(t){t.preventDefault();var t=document.getElementById("edit-sport-id").value,e=new FormData,a=(e.append("name",document.getElementById("edit-sport-name").value),e.append("description",document.getElementById("edit-sport-description").value),e.append("existing_image_path",document.getElementById("edit-existing-image-path").value),document.getElementById("edit-sport-image").files[0]);a&&e.append("image",a);try{if(!(await fetch("http://localhost:3001/api/admin/sports/"+t,{method:"PUT",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:e})).ok)throw new Error("Failed to update sport");closeModal("edit-sport-modal"),this.reset(),loadSports(),loadDashboardCounts(),loadSportsForSelect(),showSuccess("Sporten har uppdaterats")}catch(t){console.error("Error updating sport:",t),showError("Kunde inte uppdatera sport")}}),document.getElementById("edit-schedule-form").addEventListener("submit",async function(t){t.preventDefault();var t=document.getElementById("edit-schedule-id").value,e={sport_id:parseInt(document.getElementById("edit-schedule-sport").value),day_of_week:document.getElementById("edit-schedule-day").value,start_time:document.getElementById("edit-schedule-start-time").value,end_time:document.getElementById("edit-schedule-end-time").value,age_group:document.getElementById("edit-schedule-age-group").value};try{if(!(await fetch("http://localhost:3001/api/admin/schedules/"+t,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(e)})).ok)throw new Error("Failed to update schedule");closeModal("edit-schedule-modal"),this.reset(),loadSchedules(),loadDashboardCounts(),showSuccess("Schemat har uppdaterats")}catch(t){console.error("Error updating schedule:",t),alert("Kunde inte uppdatera schema")}}),document.getElementById("add-admin-form").addEventListener("submit",async function(t){t.preventDefault();t={first_name:document.getElementById("admin-firstname").value,last_name:document.getElementById("admin-lastname").value,email:document.getElementById("admin-email").value,phone:document.getElementById("admin-phone").value,password:document.getElementById("admin-password").value};try{if(!(await fetch("http://localhost:3001/api/auth/register-admin",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(t)})).ok)throw new Error("Failed to add admin");closeModal("add-admin-modal"),this.reset(),loadAdmins(),loadDashboardCounts(),showSuccess("Administratören har lagts till")}catch(t){console.error("Error adding admin:",t),showError("Kunde inte lägga till administratör")}})}document.addEventListener("DOMContentLoaded",function(){var t=localStorage.getItem("token"),e=JSON.parse(localStorage.getItem("user")||"null");t&&e&&"admin"===e.role?(document.getElementById("logout-btn").addEventListener("click",function(){localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="admin.html"}),document.querySelector(".dashboard-header p").textContent=`Välkommen, ${e.first_name} `+e.last_name,loadDashboardCounts(),loadSportsForSelect(),document.querySelectorAll(".dashboard-card").forEach(t=>{t.addEventListener("click",()=>{showSection(t.getAttribute("data-section"))})}),initializeForms()):window.location.href="admin.html"});