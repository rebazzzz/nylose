function showSection(e){document.querySelectorAll(".content-section").forEach(e=>e.style.display="none");var t=document.getElementById(e+"-section");if(t)switch(t.style.display="block",e){case"users":loadUsers();break;case"sports":loadSports();break;case"schedules":loadSchedules();break;case"statistics":loadStatistics()}}function hideAllSections(){document.querySelectorAll(".content-section").forEach(e=>e.style.display="none")}function showAddSportModal(){document.getElementById("add-sport-modal").style.display="block"}function showAddScheduleModal(){document.getElementById("add-schedule-modal").style.display="block"}function closeModal(e){document.getElementById(e).style.display="none"}async function loadDashboardCounts(){try{var[e,t,o]=await Promise.all([fetch("http://localhost:3001/api/admin/users",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}}),fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}}),fetch("http://localhost:3001/api/admin/schedules",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}})]),a=await e.json(),d=await t.json(),n=await o.json();document.getElementById("members-count").textContent=a.length+" medlemmar",document.getElementById("sports-count").textContent=d.length+" sporter",document.getElementById("schedules-count").textContent=n.length+" scheman"}catch(e){console.error("Error loading dashboard counts:",e),document.getElementById("members-count").textContent="Kunde inte ladda",document.getElementById("sports-count").textContent="Kunde inte ladda",document.getElementById("schedules-count").textContent="Kunde inte ladda"}}function showSection(e){document.querySelectorAll(".content-section").forEach(e=>e.style.display="none");var t=document.getElementById(e+"-section");if(t)switch(t.style.display="block",e){case"users":loadUsers();break;case"sports":loadSports();break;case"schedules":loadSchedules();break;case"statistics":loadStatistics()}}function hideAllSections(){document.querySelectorAll(".content-section").forEach(e=>e.style.display="none")}async function loadUsers(){try{var e=await fetch("http://localhost:3001/api/admin/users",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch users");var t=await e.json(),o=document.getElementById("users-tbody");0===t.length?o.innerHTML='<tr><td colspan="7">Inga medlemmar registrerade</td></tr>':o.innerHTML=t.map(e=>`
            <tr>
                <td>${e.id}</td>
                <td>${e.first_name} ${e.last_name}</td>
                <td>${e.email}</td>
                <td>${e.phone||"-"}</td>
                <td>${e.membership_type||"Grund"}</td>
                <td>
                    <span class="status ${e.is_active?"active":"inactive"}">
                        ${e.is_active?"Aktiv":"Inaktiv"}
                    </span>
                </td>
                <td>
                    <button class="btn btn-small" onclick="toggleUserStatus(${e.id}, ${!e.is_active})">
                        ${e.is_active?"Inaktivera":"Aktivera"}
                    </button>
                </td>
            </tr>
        `).join("")}catch(e){console.error("Error loading users:",e),document.getElementById("users-tbody").innerHTML='<tr><td colspan="7">Kunde inte ladda medlemmar</td></tr>'}}async function loadSports(){try{var e=await fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch sports");var t=await e.json(),o=document.getElementById("sports-tbody");0===t.length?o.innerHTML='<tr><td colspan="5">Inga sporter tillgängliga</td></tr>':o.innerHTML=t.map(e=>`
            <tr>
                <td>${e.id}</td>
                <td>${e.name}</td>
                <td>${e.description}</td>
                <td>${e.age_groups.join(", ")}</td>
                <td>
                    <button class="btn btn-small" onclick="editSport(${e.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteSport(${e.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join("")}catch(e){console.error("Error loading sports:",e),document.getElementById("sports-tbody").innerHTML='<tr><td colspan="5">Kunde inte ladda sporter</td></tr>'}}async function loadSchedules(){try{var e=await fetch("http://localhost:3001/api/admin/schedules",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch schedules");var t=await e.json(),o=document.getElementById("schedules-tbody");0===t.length?o.innerHTML='<tr><td colspan="6">Inga scheman tillgängliga</td></tr>':o.innerHTML=t.map(e=>`
            <tr>
                <td>${e.id}</td>
                <td>${e.sport_name}</td>
                <td>${e.day_of_week||e.day}</td>
                <td>${e.start_time} - ${e.end_time}</td>
                <td>${e.age_group}</td>
                <td>
                    <button class="btn btn-small" onclick="editSchedule(${e.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteSchedule(${e.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join("")}catch(e){console.error("Error loading schedules:",e),document.getElementById("schedules-tbody").innerHTML='<tr><td colspan="7">Kunde inte ladda schema</td></tr>'}}async function loadStatistics(){try{var e=await fetch("http://localhost:3001/api/admin/statistics",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch statistics");var t=await e.json();document.getElementById("statistics-content").innerHTML=`
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Totalt antal medlemmar</h3>
                    <p class="stat-number">${t.totalUsers}</p>
                </div>
                <div class="stat-card">
                    <h3>Aktiva medlemmar</h3>
                    <p class="stat-number">${t.activeUsers}</p>
                </div>
                <div class="stat-card">
                    <h3>Totalt antal sporter</h3>
                    <p class="stat-number">${t.totalSports}</p>
                </div>
                <div class="stat-card">
                    <h3>Totalt antal scheman</h3>
                    <p class="stat-number">${t.totalSchedules}</p>
                </div>
                <div class="stat-card">
                    <h3>Totala betalningar</h3>
                    <p class="stat-number">${t.totalPayments} kr</p>
                </div>
                <div class="stat-card">
                    <h3>Genomsnittlig betalning</h3>
                    <p class="stat-number">${t.averagePayment} kr</p>
                </div>
            </div>
        `}catch(e){console.error("Error loading statistics:",e),document.getElementById("statistics-content").innerHTML="Kunde inte ladda statistik"}}async function loadSportsForSelect(){try{var e=await fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch sports");let t=await e.json();["schedule-sport","edit-schedule-sport"].forEach(e=>{e=document.getElementById(e);e&&(e.innerHTML='<option value="">Välj sport...</option>'+t.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""))})}catch(e){console.error("Error loading sports for select:",e)}}async function toggleUserStatus(e,t){try{if(!(await fetch(`http://localhost:3001/api/admin/users/${e}/status`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({is_active:t})})).ok)throw new Error("Failed to update user status");loadUsers(),loadDashboardCounts()}catch(e){console.error("Error updating user status:",e),alert("Kunde inte uppdatera användarstatus")}}async function deleteSport(e){if(confirm("Är du säker på att du vill ta bort denna sport?"))try{if(!(await fetch("http://localhost:3001/api/admin/sports/"+e,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}})).ok)throw new Error("Failed to delete sport");loadSports(),loadDashboardCounts(),loadSportsForSelect()}catch(e){console.error("Error deleting sport:",e),alert("Kunde inte ta bort sport")}}async function deleteSchedule(e){if(confirm("Är du säker på att du vill ta bort detta schema?"))try{if(!(await fetch("http://localhost:3001/api/admin/schedules/"+e,{method:"DELETE",headers:{Authorization:"Bearer "+localStorage.getItem("token")}})).ok)throw new Error("Failed to delete schedule");loadSchedules(),loadDashboardCounts()}catch(e){console.error("Error deleting schedule:",e),alert("Kunde inte ta bort schema")}}function showAddSportModal(){document.getElementById("add-sport-modal").style.display="block"}function showAddScheduleModal(){document.getElementById("add-schedule-modal").style.display="block"}async function editSport(t){try{var e=await fetch("http://localhost:3001/api/admin/sports",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch sports");var o=(await e.json()).find(e=>e.id===t);if(!o)throw new Error("Sport not found");document.getElementById("edit-sport-id").value=o.id,document.getElementById("edit-sport-name").value=o.name,document.getElementById("edit-sport-description").value=o.description,document.getElementById("edit-existing-image-path").value=o.image_path||"",document.getElementById("edit-age-6-13").checked=o.age_groups.includes("6-13"),document.getElementById("edit-age-14+").checked=o.age_groups.includes("14+"),document.getElementById("edit-age-7-13").checked=o.age_groups.includes("7-13"),document.getElementById("edit-age-13+").checked=o.age_groups.includes("13+"),document.getElementById("edit-sport-modal").style.display="block"}catch(e){console.error("Error loading sport for edit:",e),alert("Kunde inte ladda sport för redigering")}}async function editSchedule(t){try{var e=await fetch("http://localhost:3001/api/admin/schedules",{headers:{Authorization:"Bearer "+localStorage.getItem("token")}});if(!e.ok)throw new Error("Failed to fetch schedules");var o=(await e.json()).find(e=>e.id===t);if(!o)throw new Error("Schedule not found");document.getElementById("edit-schedule-id").value=o.id,document.getElementById("edit-schedule-sport").value=o.sport_id,document.getElementById("edit-schedule-day").value=o.day_of_week||o.day,document.getElementById("edit-schedule-start-time").value=o.start_time,document.getElementById("edit-schedule-end-time").value=o.end_time,document.getElementById("edit-schedule-age-group").value=o.age_group,document.getElementById("edit-schedule-modal").style.display="block"}catch(e){console.error("Error loading schedule for edit:",e),alert("Kunde inte ladda schema för redigering")}}function closeModal(e){document.getElementById(e).style.display="none"}function initializeForms(){document.getElementById("add-sport-form").addEventListener("submit",async function(e){e.preventDefault();var e=[],t=(document.querySelector('#add-sport-modal input[value="6-13"]').checked&&e.push("6-13"),document.querySelector('#add-sport-modal input[value="14+"]').checked&&e.push("14+"),document.querySelector('#add-sport-modal input[value="7-13"]').checked&&e.push("7-13"),document.querySelector('#add-sport-modal input[value="13+"]').checked&&e.push("13+"),new FormData),e=(t.append("name",document.getElementById("sport-name").value),t.append("description",document.getElementById("sport-description").value),t.append("age_groups",JSON.stringify(e)),document.getElementById("sport-image").files[0]);e&&t.append("image",e);try{if(!(await fetch("http://localhost:3001/api/admin/sports",{method:"POST",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:t})).ok)throw new Error("Failed to add sport");closeModal("add-sport-modal"),this.reset(),loadSports(),loadDashboardCounts(),loadSportsForSelect()}catch(e){console.error("Error adding sport:",e),alert("Kunde inte lägga till sport")}}),document.getElementById("add-schedule-form").addEventListener("submit",async function(e){e.preventDefault();e={sport_id:parseInt(document.getElementById("schedule-sport").value),day_of_week:document.getElementById("schedule-day").value,start_time:document.getElementById("schedule-start-time").value,end_time:document.getElementById("schedule-end-time").value,age_group:document.getElementById("schedule-age-group").value};try{if(!(await fetch("http://localhost:3001/api/admin/schedules",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(e)})).ok)throw new Error("Failed to add schedule");closeModal("add-schedule-modal"),this.reset(),loadSchedules(),loadDashboardCounts()}catch(e){console.error("Error adding schedule:",e),alert("Kunde inte lägga till schema")}}),document.getElementById("edit-sport-form").addEventListener("submit",async function(e){e.preventDefault();var e=document.getElementById("edit-sport-id").value,t=[],o=(document.getElementById("edit-age-6-13").checked&&t.push("6-13"),document.getElementById("edit-age-14+").checked&&t.push("14+"),document.getElementById("edit-age-7-13").checked&&t.push("7-13"),document.getElementById("edit-age-13+").checked&&t.push("13+"),new FormData),t=(o.append("name",document.getElementById("edit-sport-name").value),o.append("description",document.getElementById("edit-sport-description").value),o.append("age_groups",JSON.stringify(t)),o.append("existing_image_path",document.getElementById("edit-existing-image-path").value),document.getElementById("edit-sport-image").files[0]);t&&o.append("image",t);try{if(!(await fetch("http://localhost:3001/api/admin/sports/"+e,{method:"PUT",headers:{Authorization:"Bearer "+localStorage.getItem("token")},body:o})).ok)throw new Error("Failed to update sport");closeModal("edit-sport-modal"),this.reset(),loadSports(),loadDashboardCounts(),loadSportsForSelect()}catch(e){console.error("Error updating sport:",e),alert("Kunde inte uppdatera sport")}}),document.getElementById("edit-schedule-form").addEventListener("submit",async function(e){e.preventDefault();var e=document.getElementById("edit-schedule-id").value,t={sport_id:parseInt(document.getElementById("edit-schedule-sport").value),day_of_week:document.getElementById("edit-schedule-day").value,start_time:document.getElementById("edit-schedule-start-time").value,end_time:document.getElementById("edit-schedule-end-time").value,age_group:document.getElementById("edit-schedule-age-group").value};try{if(!(await fetch("http://localhost:3001/api/admin/schedules/"+e,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify(t)})).ok)throw new Error("Failed to update schedule");closeModal("edit-schedule-modal"),this.reset(),loadSchedules(),loadDashboardCounts()}catch(e){console.error("Error updating schedule:",e),alert("Kunde inte uppdatera schema")}})}document.addEventListener("DOMContentLoaded",function(){var e=localStorage.getItem("token"),t=JSON.parse(localStorage.getItem("user")||"null");e&&t&&"admin"===t.role?(document.getElementById("logout-btn").addEventListener("click",function(){localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="admin.html"}),document.querySelector(".dashboard-header p").textContent=`Välkommen, ${t.first_name} `+t.last_name,loadDashboardCounts(),loadSportsForSelect(),initializeForms()):window.location.href="admin.html"});