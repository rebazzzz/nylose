document.addEventListener("DOMContentLoaded",function(){let s=document.getElementById("personnummer"),i=document.querySelectorAll(".parent-field"),o=document.getElementById("register-btn"),l=document.querySelector(".registration-form");if(s){let e="YYYYMMDD-XXXX",a=(s.value=e,0);s.addEventListener("keydown",function(t){"0"<=t.key&&t.key<="9"?(t.preventDefault(),a<e.length&&"-"!==e[a]&&(n=s.value.substring(0,a)+t.key+s.value.substring(a+1),s.value=n,++a<e.length&&"-"===e[a]&&a++,s.setSelectionRange(a,a))):"Backspace"===t.key?(t.preventDefault(),0<a&&(a<e.length&&"-"===e[a-1]&&a--,a--,n=e[a],n=s.value.substring(0,a)+n+s.value.substring(a+1),s.value=n,s.setSelectionRange(a,a))):t.preventDefault();var n=s.value.replace(/[^0-9]/g,"");if(8<=n.length){var t=n.substring(0,8),n=parseInt(t.substring(0,4)),r=parseInt(t.substring(4,6))-1,t=parseInt(t.substring(6,8)),n=new Date(n,r,t),r=new Date;let e=r.getFullYear()-n.getFullYear();t=r.getMonth()-n.getMonth();(t<0||0==t&&r.getDate()<n.getDate())&&e--,e<18?i.forEach(e=>{e.style.display="flex";e=e.querySelector("input");e&&(e.required=!0)}):i.forEach(e=>{e.style.display="none";e=e.querySelector("input");e&&(e.required=!1)})}else i.forEach(e=>{e.style.display="none";e=e.querySelector("input");e&&(e.required=!1)})})}l&&o&&l.addEventListener("submit",async function(e){e.preventDefault();var e=new FormData(l),t={first_name:e.get("firstname"),last_name:e.get("lastname"),personnummer:e.get("personnummer").replace(/[^0-9-]/g,""),email:e.get("email"),phone:e.get("phone"),address:e.get("address"),password:"temp_password_"+Date.now()};o.disabled=!0,o.textContent="Registrerar...";try{var n,r,a=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await a.json();a.ok?(n=await fetch("/api/member/profile",{method:"GET",headers:{Authorization:"Bearer "+s.token}})).ok?(r=(await n.json()).membership,(await fetch("/api/auth/payment",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s.token},body:JSON.stringify({membership_id:r.id,payment_method:e.get("payment-method")})})).ok?(alert("Registrering och betalning genomförd! Kontrollera din e-post för bekräftelse."),window.location.href="index.html"):alert("Registrering lyckades men betalning misslyckades. Kontakta oss för hjälp.")):alert("Registrering lyckades men kunde inte hitta medlemskap. Kontakta oss för hjälp."):alert("Registrering misslyckades: "+s.error)}catch(e){console.error("Registration error:",e),alert("Ett fel uppstod. Försök igen senare.")}finally{o.disabled=!1,o.textContent="Skicka anmälan"}})});