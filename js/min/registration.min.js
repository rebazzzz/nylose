document.addEventListener("DOMContentLoaded",function(){let s=document.getElementById("personnummer"),i=document.querySelectorAll(".parent-field"),o=document.getElementById("register-btn"),l=document.querySelector(".registration-form");if(s){let e="YYYYMMDD-XXXX",r=(s.value=e,0);s.addEventListener("keydown",function(t){"0"<=t.key&&t.key<="9"?(t.preventDefault(),r<e.length&&"-"!==e[r]&&(n=s.value.substring(0,r)+t.key+s.value.substring(r+1),s.value=n,++r<e.length&&"-"===e[r]&&r++,s.setSelectionRange(r,r))):"Backspace"===t.key?(t.preventDefault(),0<r&&(r<e.length&&"-"===e[r-1]&&r--,r--,n=e[r],n=s.value.substring(0,r)+n+s.value.substring(r+1),s.value=n,s.setSelectionRange(r,r))):t.preventDefault();var n=s.value.replace(/[^0-9]/g,"");if(8<=n.length){var t=n.substring(0,8),n=parseInt(t.substring(0,4)),a=parseInt(t.substring(4,6))-1,t=parseInt(t.substring(6,8)),n=new Date(n,a,t),a=new Date;let e=a.getFullYear()-n.getFullYear();t=a.getMonth()-n.getMonth();(t<0||0==t&&a.getDate()<n.getDate())&&e--,e<18?i.forEach(e=>{e.style.display="flex";e=e.querySelector("input");e&&(e.required=!0)}):i.forEach(e=>{e.style.display="none";e=e.querySelector("input");e&&(e.required=!1)})}else i.forEach(e=>{e.style.display="none";e=e.querySelector("input");e&&(e.required=!1)})})}l&&o&&l.addEventListener("submit",async function(e){e.preventDefault();var e=new FormData(l),t={first_name:e.get("firstname"),last_name:e.get("lastname"),personnummer:e.get("personnummer").replace(/[^0-9-]/g,""),email:e.get("email"),phone:e.get("phone"),address:e.get("address"),password:e.get("password")};o.disabled=!0,o.textContent="Registrerar...";try{var n,a,r=await fetch("http://localhost:3001/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await r.json();r.ok?(n=await fetch("http://localhost:3001/api/member/profile",{method:"GET",headers:{Authorization:"Bearer "+s.token}})).ok?(a=(await n.json()).membership,(await fetch("http://localhost:3001/api/auth/payment",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s.token},body:JSON.stringify({membership_id:a.id,payment_method:e.get("payment-method")})})).ok?(alert("Registrering och betalning genomförd! Kontrollera din e-post för bekräftelse."),window.location.href="index.html"):alert("Registrering lyckades men betalning misslyckades. Kontakta oss för hjälp.")):alert("Registrering lyckades men kunde inte hitta medlemskap. Kontakta oss för hjälp."):alert("Registrering misslyckades: "+s.error)}catch(e){console.error("Registration error:",e),alert("Ett fel uppstod. Försök igen senare.")}finally{o.disabled=!1,o.textContent="Skicka anmälan"}})});