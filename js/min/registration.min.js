document.addEventListener("DOMContentLoaded",function(){let s=document.getElementById("personnummer"),r=document.querySelectorAll(".parent-field"),o=document.getElementById("register-btn"),l=document.querySelector(".registration-form");function c(e,t="info",n="Meddelande"){var a=document.getElementById("notification-modal"),i=document.getElementById("notification-title"),s=document.getElementById("notification-message"),r=document.getElementById("notification-icon");i.textContent=n,s.textContent=e,r.className="notification-icon";let o="fas fa-info-circle";switch(t){case"success":o="fas fa-check-circle",r.classList.add("success");break;case"error":o="fas fa-exclamation-triangle",r.classList.add("error");break;case"warning":o="fas fa-exclamation-circle",r.classList.add("warning");break;default:r.classList.add("info")}r.innerHTML=`<i class="${o}"></i>`,document.getElementById("notification-confirm-btn").onclick=d,a.style.display="block"}function d(){document.getElementById("notification-modal").style.display="none"}function g(e,t="Fel"){c(e,"error",t)}if(s){let e="YYYYMMDD-XXXX",i=(s.value=e,0);s.addEventListener("keydown",function(t){"0"<=t.key&&t.key<="9"?(t.preventDefault(),i<e.length&&"-"!==e[i]&&(n=s.value.substring(0,i)+t.key+s.value.substring(i+1),s.value=n,++i<e.length&&"-"===e[i]&&i++,s.setSelectionRange(i,i))):"Backspace"===t.key?(t.preventDefault(),0<i&&(i<e.length&&"-"===e[i-1]&&i--,i--,n=e[i],n=s.value.substring(0,i)+n+s.value.substring(i+1),s.value=n,s.setSelectionRange(i,i))):t.preventDefault();var n=s.value.replace(/[^0-9]/g,"");if(8<=n.length){var t=n.substring(0,8),n=parseInt(t.substring(0,4)),a=parseInt(t.substring(4,6))-1,t=parseInt(t.substring(6,8)),n=new Date(n,a,t),a=new Date;let e=a.getFullYear()-n.getFullYear();t=a.getMonth()-n.getMonth();(t<0||0==t&&a.getDate()<n.getDate())&&e--,e<18?r.forEach(e=>{e.style.display="flex";e=e.querySelector("input");e&&(e.required=!0)}):r.forEach(e=>{e.style.display="none";e=e.querySelector("input");e&&(e.required=!1)})}else r.forEach(e=>{e.style.display="none";e=e.querySelector("input");e&&(e.required=!1)})})}l&&o&&l.addEventListener("submit",async function(e){e.preventDefault();var e=new FormData(l),t={first_name:e.get("firstname"),last_name:e.get("lastname"),personnummer:e.get("personnummer").replace(/[^0-9-]/g,""),email:e.get("email"),phone:e.get("phone"),address:e.get("address"),password:e.get("password")};o.disabled=!0,o.textContent="Registrerar...";try{var n,a,i=await fetch("http://localhost:3001/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await i.json();i.ok?(n=await fetch("http://localhost:3001/api/member/profile",{method:"GET",headers:{Authorization:"Bearer "+s.token}})).ok?(a=(await n.json()).membership,(await fetch("http://localhost:3001/api/auth/payment",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+s.token},body:JSON.stringify({membership_id:a.id,payment_method:e.get("payment-method")})})).ok?(c("Registrering och betalning genomförd! Kontrollera din e-post för bekräftelse.","success","Registrering lyckades"),window.location.href="index.html"):g("Registrering lyckades men betalning misslyckades. Kontakta oss för hjälp.","Betalningsfel")):g("Registrering lyckades men kunde inte hitta medlemskap. Kontakta oss för hjälp.","Medlemskapsfel"):g("Registrering misslyckades: "+s.error,"Registreringsfel")}catch(e){console.error("Registration error:",e),g("Ett fel uppstod. Försök igen senare.","Fel")}finally{o.disabled=!1,o.textContent="Skicka anmälan"}})});